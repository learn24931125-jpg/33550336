<H1>æ™ºæ…§æ—…éŠå°è¦½</H1>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºæ…§æ—…éŠå°è¦½ç³»çµ± - å°ç£ (Neumorphism)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ========================================= */
        /* CSS æ¨£å¼ (style.css å…§å®¹) */
        /* ========================================= */
        :root {
            /* ä¸»è¦èƒŒæ™¯è‰² - æ·ºç°è‰²èª¿ */
            --main-color: #e0e5ec; 
            /* è¼ƒæ·ºçš„é™°å½±é¡è‰² */
            --light-color: #ffffff;
            /* è¼ƒæ·±çš„é™°å½±é¡è‰² */
            --dark-color: #a3b1c6; 
            /* ä¸»è‰²èª¿ - ç”¨æ–¼æŒ‰éˆ•æˆ–å¼·èª¿ */
            --primary-color: #4CAF50;
            --accent-color: #007bff;

            /* Neumorphism é™°å½±åƒæ•¸ */
            --shadow-light: -7px -7px 15px var(--light-color);
            --shadow-dark: 7px 7px 15px var(--dark-color);
            --shadow-inset-light: inset 5px 5px 10px var(--dark-color);
            --shadow-inset-dark: inset -5px -5px 10px var(--light-color);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background-color: var(--main-color);
            padding: 20px;
        }

        .container {
            display: grid;
            /* ä½ˆå±€: é¸å–®å€ (280px) | ä¸»è¦å…§å®¹å€ (å‰©é¤˜ç©ºé–“) */
            grid-template-columns: 280px 1fr; 
            /* æ¨™é¡Œå€ | é¸å–®å€ / ä¸»è¦å…§å®¹å€ */
            grid-template-rows: auto 1fr; 
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* --- æŸ”å’Œäºå…‹åŠ› (Neumorphism) åŸºç¤æ¨£å¼ --- */

        .neumorphism-panel,
        .neumorphism-card {
            background: var(--main-color);
            border-radius: var(--border-radius);
            padding: 20px;
            /* æ¨™æº–æµ®é›•æ•ˆæœ */
            box-shadow: var(--shadow-dark), var(--shadow-light); 
        }

        /* è®“æ¨™é¡Œå€æ©«è·¨å…©æ¬„ */
        .header-panel {
            grid-column: 1 / -1; 
            text-align: center;
            padding: 30px 20px;
        }

        /* --- APIè¨­å®šå€èˆ‡é¸å–®å€ --- */

        .api-settings {
            grid-column: 1 / 2;
        }

        .sidebar {
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* API è¼¸å…¥æ¡† */
        .input-group {
            margin-bottom: 15px;
        }

        .neumorphism-input,
        .neumorphism-select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            background: var(--main-color);
            border-radius: 8px;
            /* å‡¹é™·æ•ˆæœ */
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark); 
            transition: all 0.2s ease-in-out;
        }

        .neumorphism-input:focus,
        .neumorphism-select:focus {
            outline: none;
            /* è¼•å¾®çš„é‚Šæ¡†çªå‡ºï¼Œå¼·èª¿èšç„¦ */
            box-shadow: inset 2px 2px 5px var(--dark-color), inset -2px -2px 5px var(--light-color); 
        }

        /* é¸å–®åˆ—è¡¨ */
        .menu-list {
            list-style: none;
            padding: 0;
        }

        .neumorphism-item {
            display: block;
            text-decoration: none;
            color: #333;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: var(--main-color);
            /* æµ®é›•æ•ˆæœ */
            box-shadow: var(--shadow-dark), var(--shadow-light); 
            transition: all 0.3s ease;
        }

        .neumorphism-item:hover {
            /* æ‡¸åœæ™‚æ¨¡æ“¬æŒ‰ä¸‹çš„å‡¹é™·æ•ˆæœ */
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark); 
        }

        .neumorphism-item.active {
            /* é¸æ“‡ä¸­çš„é …ç›®é¡¯ç¤ºå‡¹é™· */
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark); 
            color: var(--primary-color);
            font-weight: bold;
        }

        .neumorphism-item.disabled {
            color: #999;
            cursor: default;
            box-shadow: none;
            background: #f0f4f8;
        }


        /* --- æŒ‰éˆ•æ¨£å¼ --- */

        .neumorphism-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            background: var(--main-color);
            /* æµ®é›•æ•ˆæœ */
            box-shadow: var(--shadow-dark), var(--shadow-light); 
            transition: all 0.2s ease-in-out;
            margin-top: 10px;
        }

        .neumorphism-button:hover {
            /* æ‡¸åœæ™‚è®“é™°å½±æ›´æ˜é¡¯ï¼Œå¢åŠ äº’å‹•æ„Ÿ */
            box-shadow: 10px 10px 20px var(--dark-color), -10px -10px 20px var(--light-color);
        }

        .neumorphism-button:active {
            /* æŒ‰ä¸‹æ™‚çš„å‡¹é™·æ•ˆæœ */
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark); 
        }

        /* ä¸»è‰²èª¿æŒ‰éˆ• */
        .primary-button {
            color: white;
            background-color: var(--primary-color);
            box-shadow: 5px 5px 10px rgba(76, 175, 80, 0.4), -5px -5px 10px rgba(76, 175, 80, 0.7);
        }

        .accent-button {
            color: white;
            background-color: var(--accent-color);
            box-shadow: 5px 5px 10px rgba(0, 123, 255, 0.4), -5px -5px 10px rgba(0, 123, 255, 0.7);
        }

        .small-button {
            padding: 8px 12px;
            font-size: 0.9em;
            margin-right: 5px;
        }

        /* --- ä¸»è¦å…§å®¹å€ --- */

        .main-content {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* æ™¯é»å¡ç‰‡å€ */
        .attraction-cards h2 {
            margin-bottom: 15px;
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .attraction-card {
            width: calc(50% - 10px); /* å…©æ¬„ä½ˆå±€ */
            display: flex;
            overflow: hidden;
            /* åˆå§‹ç‹€æ…‹ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
            display: none; 
        }

        .card-image-placeholder {
            width: 40%;
            min-height: 180px;
            background-color: #d8dee8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #666;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            text-align: center;
            overflow: hidden;
        }

        .card-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-content {
            width: 60%;
            padding: 15px;
        }

        .card-content h3 {
            margin-top: 0;
            color: #333;
        }

        .description {
            margin: 10px 0 15px;
            color: #555;
            font-size: 0.9em;
        }

        /* åœ°åœ–å±•ç¤ºå€ */
        .map-display {
            padding: 30px;
        }

        .map-placeholder {
            width: 100%;
            min-height: 400px;
            background-color: #d8dee8;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #444;
            /* åœ°åœ–å€ä½¿ç”¨å‡¹é™·æ•ˆæœ */
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark); 
            text-align: center;
            padding: 20px;
        }

        .route-planning label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .route-planning button {
            width: 100%;
        }

        pre {
            white-space: pre-wrap;
            font-family: monospace;
            line-height: 1.5;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="neumorphism-panel header-panel">
            <h1>ğŸ‡¹ğŸ‡¼ AIæ™ºæ…§æ—…éŠå°è¦½ç³»çµ±</h1>
            <p>é€éAIè¦åŠƒæ‚¨çš„å°ç£ä¹‹æ—…ï¼Œæ¢ç´¢ç²¾å½©æ™¯é»ã€‚</p>
        </header>

        <section class="api-settings neumorphism-panel">
            <h2>âš™ï¸ API è¨­å®šå€</h2>
            <div class="input-group">
                <label for="gemini-key">Gemini API Key:</label>
                <input type="password" id="gemini-key" placeholder="è¼¸å…¥æ‚¨çš„API Key" class="neumorphism-input">
                <p id="api-status" style="font-size: 0.9em; margin-top: 5px;"></p>
            </div>
            <button id="verify-api-btn" class="neumorphism-button primary-button">é©—è­‰ä¸¦ä¿å­˜è¨­å®š</button>
        </section>

        <nav class="sidebar neumorphism-panel">
            <h2>ğŸ—ºï¸ è·¯ç·šè¦åŠƒèˆ‡æ™¯é»</h2>
            
            <ul class="menu-list" id="category-menu">
                <li><a href="#" class="neumorphism-item active" data-filter="all">ğŸ‡¹ğŸ‡¼ æ‰€æœ‰æ™¯é»</a></li>
                <li><a href="#" class="neumorphism-item" data-filter="nature">ğŸï¸ è‡ªç„¶é¢¨å…‰æ™¯é»</a></li>
                <li><a href="#" class="neumorphism-item" data-filter="history">ğŸ›ï¸ æ­·å²æ–‡åŒ–å¤è¹Ÿ</a></li>
                <li><a href="#" class="neumorphism-item" data-filter="city">ğŸ™ï¸ åŸå¸‚éƒ½æœƒé«”é©—</a></li>
            </ul>

            <hr style="border-top: 1px solid #c0c0c0; margin: 15px 0;">

            <div class="route-overview">
                <h3>ğŸ“… AI è¡Œç¨‹æ¦‚è¦½</h3>
                <ul id="itinerary-days-menu" class="menu-list">
                    <li><a href="#" class="neumorphism-item disabled">é»æ“Šã€Œç”Ÿæˆå„ªåŒ–è·¯ç·šã€</a></li>
                </ul>
            </div>

            <div class="route-planning">
                <h3>AI è·¯ç·šç”Ÿæˆ</h3>
                
                <label for="start-location">èµ·å§‹åœ°ï¼š</label>
                <input type="text" id="start-location" placeholder="è¼¸å…¥èµ·é» (e.g., å°åŒ—è»Šç«™)" class="neumorphism-input">

                <label for="interest-tags">æ—…éŠåå¥½ (Tag)ï¼š</label>
                <input type="text" id="interest-tags" placeholder="è‡ªç„¶,ç¾é£Ÿ,æ­·å²..." class="neumorphism-input">

                <label for="duration-days">å¤©æ•¸ï¼š</label>
                <select id="duration-days" class="neumorphism-select">
                    <option value="1">1å¤©</option>
                    <option value="2">2å¤©</option>
                    <option value="3" selected>3å¤©</option>
                    <option value="5">5å¤©</option>
                </select>
                
                <label for="must-visit">å¿…è¨ªæ™¯é» (é¸å¡«)ï¼š</label>
                <input type="text" id="must-visit" placeholder="ä»¥é€—è™Ÿåˆ†éš” (e.g., 101,æ—¥æœˆæ½­)" class="neumorphism-input">

                <button id="generate-route-btn" class="neumorphism-button accent-button">ğŸ”¥ ç”Ÿæˆå„ªåŒ–è·¯ç·š</button>
                
                <div id="route-result" style="margin-top: 15px; padding: 10px; font-size: 0.9em; display:none;">
                    </div>
            </div>
        </nav>

        <main class="main-content">
            <section class="attraction-cards">
                <h2>ğŸŒŸ ç²¾é¸æ™¯é»å¡ç‰‡</h2>
                <div id="cards-container" class="cards-container">
                    </div>
            </section>

            <section id="map-display" class="map-display neumorphism-panel">
                <h2>ğŸ“ åœ°åœ–å±•ç¤ºå€</h2>
                <div id="map-placeholder" class="map-placeholder">
                    [åœ°åœ–æ¨¡æ“¬ç•«é¢ï¼šé¡¯ç¤ºè·¯ç·šå’Œæ™¯é»æ¨™è¨˜]
                </div>
            </section>
        </main>
    </div>

    <script>
        /* ========================================= */
        /* JavaScript äº’å‹•é‚è¼¯ (script.js å…§å®¹) */
        /* ========================================= */

        // --- æ¨¡æ“¬è³‡æ–™ ---
        const taiwanAttractions = [
            {
                id: 'sunmoon',
                name: 'æ—¥æœˆæ½­',
                description: 'è‡ºç£æœ€å¤§çš„å¤©ç„¶æ¹–æ³Šï¼Œæ¹–å…‰å±±è‰²ï¼Œé¢¨æ™¯ç§€éº—ã€‚æ¯å¹´å¸å¼•å¤§é‡éŠå®¢é€ è¨ªï¼Œæ˜¯åœ‹éš›çŸ¥åçš„è§€å…‰å‹åœ°ã€‚',
                coordinates: 'N 23.8966, E 120.9167',
                coord_val: { x: 10, y: 15 }, // æ¨¡æ“¬åœ°åœ–ä¸Šçš„ä½ç½®å€¼
                score: 95, // å¸å¼•åŠ›åˆ†æ•¸
                tags: ['è‡ªç„¶', 'æ¹–æ™¯', 'ä¼‘é–’'],
                image: 'images/sunmoon_default.jpg' // åˆå§‹é è¨­åœ–ç‰‡
            },
            {
                id: 'taipei101',
                name: 'å°åŒ—101',
                description: 'æ›¾ç‚ºä¸–ç•Œç¬¬ä¸€é«˜æ¨“ï¼Œæ˜¯å°åŒ—å¸‚é‡è¦çš„åœ°æ¨™ã€‚é ‚æ¨“è§€æ™¯å°å¯ä¿¯ç°å¤§å°åŒ—éƒ½æœƒå€çš„å£¯éº—æ™¯è‰²ã€‚',
                coordinates: 'N 25.0330, E 121.5654',
                coord_val: { x: 5, y: 5 },
                score: 98,
                tags: ['åŸå¸‚', 'åœ°æ¨™', 'è³¼ç‰©'],
                image: 'images/taipei101_default.jpg'
            },
            {
                id: 'taroko',
                name: 'å¤ªé­¯é–£åœ‹å®¶å…¬åœ’',
                description: 'ä»¥é›„å‰å£¯éº—çš„å³½è°·æ™¯è§€èåã€‚ç«‹éœ§æºªåˆ‡å‰²è€Œæˆçš„Vå½¢å³½è°·ï¼Œæ˜¯ä¸–ç•Œç´šçš„è‡ªç„¶å¥‡è§€ã€‚',
                coordinates: 'N 24.1667, E 121.5000',
                coord_val: { x: 30, y: 25 },
                score: 92,
                tags: ['è‡ªç„¶', 'å³½è°·', 'å¥è¡Œ'],
                image: 'images/taroko_default.jpg'
            },
            {
                id: 'ali',
                name: 'é˜¿é‡Œå±±',
                description: 'äº”å¥‡ï¼ˆæ—¥å‡ºã€é›²æµ·ã€æ™šéœã€æ£®æ—ã€éµé“ï¼‰èåä¸­å¤–ã€‚',
                coordinates: 'N 23.5152, E 120.8123',
                coord_val: { x: 15, y: 35 },
                score: 90,
                tags: ['è‡ªç„¶', 'æ—¥å‡º', 'æ£®æ—'],
                image: 'images/ali_default.jpg'
            },
            {
                id: 'tainan_old',
                name: 'å®‰å¹³å¤å ¡',
                description: 'è‡ºç£æœ€å¤è€çš„åŸå ¡ä¹‹ä¸€ï¼Œè¦‹è­‰äº†è‡ºç£æ­·å²çš„è®Šé·ã€‚',
                coordinates: 'N 23.0016, E 120.1656',
                coord_val: { x: 25, y: 10 },
                score: 88,
                tags: ['æ­·å²', 'æ–‡åŒ–', 'å¤è¹Ÿ'],
                image: 'images/tainan_default.jpg'
            },
            {
                id: 'kaohsiung_harbor',
                name: 'é«˜é›„æ¸¯',
                description: 'è‡ºç£æœ€å¤§çš„æµ·æ¸¯ï¼Œå¤œæ™šçš„ç‡ˆå…‰æ™¯è‰²éå¸¸è¿·äººã€‚',
                coordinates: 'N 22.6167, E 120.2833',
                coord_val: { x: 20, y: 40 },
                score: 85,
                tags: ['åŸå¸‚', 'æµ·æ¸¯', 'å¤œæ™¯'],
                image: 'images/kaohsiung_default.jpg'
            }
        ];

        // âœ¨ æ–°å¢å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜è·¯ç·šè¦åŠƒçµæœ
        let currentOptimizedRoute = null; 

        // --- è¼”åŠ©å‡½æ•¸ï¼šç”Ÿæˆ Neumorphism æ™¯é»å¡ç‰‡ HTML ---
        function createAttractionCard(attraction) {
            return `
                <div class="attraction-card neumorphism-card" data-id="${attraction.id}">
                    <div class="card-image-placeholder" id="img-placeholder-${attraction.id}">
                        ${attraction.image.includes('default') 
                            ? `[AI ç”Ÿæˆåœ–ç‰‡é è¦½å€]` 
                            : `<img src="${attraction.image}" alt="${attraction.name}" style="width:100%; height:100%; object-fit:cover;">`}
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${attraction.name}</h3>
                        <p class="description card-description-${attraction.id}">${attraction.description.substring(0, 20)}...</p>
                        <div class="card-details card-details-${attraction.id}" style="display:none; margin-bottom: 10px;">
                            <p><strong>åº§æ¨™:</strong> <span class="card-coord">${attraction.coordinates}</span></p>
                        </div>
                        <button class="neumorphism-button small-button toggle-details-btn" data-id="${attraction.id}">
                            æŸ¥çœ‹è©³æƒ…
                        </button>
                        <button class="neumorphism-button small-button generate-image-btn" data-name="${attraction.name}">
                            æ¨¡æ“¬ AI ç”Ÿæˆæ–°åœ–
                        </button>
                    </div>
                </div>
            `;
        }
        
        // --- è·é›¢è¨ˆç®— (æ¨¡æ“¬æ­å¹¾é‡Œå¾—è·é›¢) ---
        function getDistance(p1, p2) {
            // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæœƒå‘¼å«åœ°åœ– API ç²å–è¡Œè»Šæˆ–æ­¥è¡Œè·é›¢ã€‚
            // é€™è£¡ä½¿ç”¨ç°¡åŒ–çš„ (x, y) æ­å¹¾é‡Œå¾—è·é›¢ä½œç‚ºæ¨¡æ“¬ã€‚
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        // 1. è¼‰å…¥æ™¯é»å¡ç‰‡
        function loadAttractionCards() {
            const container = document.getElementById('cards-container');
            container.innerHTML = taiwanAttractions.map(createAttractionCard).join('');
            
            // é è¨­é¡¯ç¤ºæ‰€æœ‰å¡ç‰‡
            filterCardsByDay(0);
        }

        // 2. è™•ç† API é©—è­‰ (æ¨¡æ“¬)
        function handleApiVerification() {
            const keyInput = document.getElementById('gemini-key');
            const statusText = document.getElementById('api-status');
            const key = keyInput.value.trim();

            if (key.length > 10 && key.startsWith('AIZA')) { // æ¨¡æ“¬ä¸€å€‹ç°¡å–®çš„æœ‰æ•ˆéµæ ¼å¼
                statusText.innerHTML = 'âœ… API Key é©—è­‰æˆåŠŸï¼å¯ä½¿ç”¨ AI åŠŸèƒ½ã€‚';
                statusText.style.color = 'var(--primary-color)';
                localStorage.setItem('geminiApiKey', key);
            } else {
                statusText.innerHTML = 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚ (æ¨¡æ“¬æ ¼å¼: AIZA...)';
                statusText.style.color = 'red';
                localStorage.removeItem('geminiApiKey');
            }
        }

        // 3. é»é¸æ™¯é» (é¡¯ç¤ºä»‹ç´¹èˆ‡åœ°åœ–åº§æ¨™)
        function toggleDetails(cardId) {
            const card = taiwanAttractions.find(a => a.id === cardId);
            const detailsDiv = document.querySelector(`.card-details-${cardId}`);
            const descriptionP = document.querySelector(`.card-description-${cardId}`);
            const toggleBtn = document.querySelector(`.toggle-details-btn[data-id="${cardId}"]`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                descriptionP.innerHTML = card.description;
                toggleBtn.textContent = 'éš±è—è©³æƒ…';
                updateMapDisplaySingle(card);
            } else {
                detailsDiv.style.display = 'none';
                descriptionP.innerHTML = card.description.substring(0, 20) + '...';
                toggleBtn.textContent = 'æŸ¥çœ‹è©³æƒ…';
                // éš±è—è©³æƒ…å¾Œï¼Œæ¢å¾©ç‚ºé¡¯ç¤ºå¤šæ™¯é» (å¦‚æœç•¶å‰æ˜¯è¡Œç¨‹è¦–åœ–)
                if (document.querySelector('#itinerary-days-menu .active')) {
                     const activeDay = document.querySelector('#itinerary-days-menu .active').getAttribute('data-day');
                     filterCardsByDay(activeDay);
                } else {
                     updateMapDisplayMultiple([]);
                }
            }
        }

        // 4. æ›´æ–°åœ°åœ–å±•ç¤ºå€ (å–®ä¸€æ™¯é»)
        function updateMapDisplaySingle(attraction) {
            const mapPlaceholder = document.getElementById('map-placeholder');
            if (attraction) {
                mapPlaceholder.innerHTML = `
                    <h3>ğŸ“Œ ${attraction.name} (åº§æ¨™: ${attraction.coordinates})</h3>
                    <p>åœ°åœ–æ¨¡æ“¬ï¼šé¡¯ç¤ºä»¥ ${attraction.name} ç‚ºä¸­å¿ƒçš„åœ–è³‡å’Œå–®ä¸€æ¨™è¨˜ã€‚</p>
                    <p style="color:#007bff; font-weight:normal;">(å¯¦éš›æ‡‰ç”¨ä¸­æ­¤è™•æœƒåµŒå…¥äº’å‹•å¼åœ°åœ–)</p>
                `;
                mapPlaceholder.style.backgroundColor = '#f0f4f8';
            }
        }

        // 5. æ¨¡æ“¬ AI ç”Ÿæˆåœ–ç‰‡
        function simulateAIGeneration(attractionName) {
            const card = taiwanAttractions.find(a => a.name === attractionName);
            if (!card) return;

            const imgPlaceholder = document.getElementById(`img-placeholder-${card.id}`);
            
            // æª¢æŸ¥ API Key æ˜¯å¦å­˜åœ¨ (ç°¡å–®é©—è­‰)
            if (!localStorage.getItem('geminiApiKey')) {
                alert('è«‹å…ˆåœ¨ã€ŒAPI è¨­å®šå€ã€è¼¸å…¥ä¸¦é©—è­‰ Gemini API Keyï¼');
                return;
            }
            
            imgPlaceholder.innerHTML = 'ğŸ–¼ï¸ AI æ­£åœ¨ç”Ÿæˆåœ–ç‰‡ä¸­...';
            imgPlaceholder.style.backgroundColor = '#e0f7fa';

            // æ¨¡æ“¬ç¶²è·¯å»¶é²å’Œ AI ç”Ÿæˆæ™‚é–“
            setTimeout(() => {
                // æ¨¡æ“¬ç”Ÿæˆä¸€å¼µæ–°åœ–ç‰‡ (é€™è£¡åªæ˜¯æ›¿æ›æˆä¸€å€‹ä¸åŒçš„ URL)
                const newImageUrl = `https://picsum.photos/seed/${Math.random()}/300/200`;
                
                // æ›´æ–°å¡ç‰‡å…§éƒ¨çš„åœ–ç‰‡
                imgPlaceholder.innerHTML = `<img src="${newImageUrl}" alt="AI ç”Ÿæˆçš„ ${attractionName} åœ–ç‰‡" style="width:100%; height:100%; object-fit:cover;">`;
                imgPlaceholder.style.backgroundColor = '#d8dee8';
                
                card.image = newImageUrl;

            }, 2000); // å»¶é² 2 ç§’
        }
        
        // 6. è¤‡é›œè·¯ç·šè¦åŠƒå‡½æ•¸ (æ¨¡æ“¬è²ªå©ªæ³•èˆ‡ç¯©é¸)
        function generateOptimizedRoute(startLocation, interestTags, durationDays, mustVisitNames) {
            const totalDays = parseInt(durationDays, 10);
            const requiredTags = interestTags.split(',').map(tag => tag.trim().toLowerCase()).filter(t => t);
            const mustVisit = mustVisitNames.split(',').map(name => name.trim()).filter(n => n);
            
            // 1. ç¯©é¸æ™¯é» (æ ¹æ“šæ¨™ç±¤å’Œå¿…è¨ª)
            let filteredAttractions = taiwanAttractions.filter(attraction => {
                const tagMatch = requiredTags.length === 0 || attraction.tags.some(tag => requiredTags.includes(tag.toLowerCase()));
                return tagMatch;
            });

            let selectedRoute = taiwanAttractions.filter(a => mustVisit.includes(a.name));
            let pool = filteredAttractions.filter(a => !mustVisit.includes(a.name));

            // 2. é¸æ“‡è¶³å¤ çš„æ™¯é» (å‡è¨­æ¯å¤©æœ€å¤šè¨ªå• 3 å€‹æ™¯é»)
            const maxAttractions = totalDays * 3;
            
            pool.sort((a, b) => b.score - a.score);
            
            for (let i = 0; selectedRoute.length < maxAttractions && i < pool.length; i++) {
                selectedRoute.push(pool[i]);
            }

            if (selectedRoute.length === 0) {
                return "æ‰¾ä¸åˆ°ç¬¦åˆæ‚¨æ¢ä»¶çš„æ™¯é»ã€‚";
            }

            // 3. è·¯ç·šå„ªåŒ– (è²ªå©ªæ³•æ¨¡æ“¬)
            let optimizedOrder = [];
            let currentPoint = { name: startLocation, coord_val: { x: 20, y: 10 } }; // æ¨¡æ“¬èµ·é»åº§æ¨™
            let remaining = [...selectedRoute];

            while (remaining.length > 0) {
                let nearestIndex = -1;
                let minDistance = Infinity;

                for (let i = 0; i < remaining.length; i++) {
                    const dist = getDistance(currentPoint.coord_val, remaining[i].coord_val);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestIndex = i;
                    }
                }
                
                const nextAttraction = remaining.splice(nearestIndex, 1)[0];
                optimizedOrder.push(nextAttraction);
                currentPoint = nextAttraction;
            }

            // 4. åˆ†æ—¥è¦åŠƒ
            const attractionsPerDay = Math.ceil(optimizedOrder.length / totalDays);
            let itinerary = [];
            let dailyStops = []; // å„²å­˜æ¯æ—¥æ™¯é»æ¸…å–®
            let totalDistance = 0;

            for (let day = 0; day < totalDays; day++) {
                const startIndex = day * attractionsPerDay;
                const stops = optimizedOrder.slice(startIndex, startIndex + attractionsPerDay);
                
                if (stops.length > 0) {
                    dailyStops.push(stops);

                    let dailyRoute = [`å¾ ${day === 0 ? startLocation : 'å‰ä¸€å¤©ä½å®¿åœ°é»'} å‡ºç™¼`];
                    let lastCoord = day === 0 ? { x: 20, y: 10 } : stops[0].coord_val;
                    
                    stops.forEach((stop) => {
                        const travelDist = getDistance(lastCoord, stop.coord_val);
                        totalDistance += travelDist;
                        
                        dailyRoute.push(`â¡ï¸ è¨ªå• ${stop.name} (åœç•™ç´„ 3å°æ™‚ï¼Œè¡Œè»Šè·é›¢æ¨¡æ“¬: ${travelDist.toFixed(1)} km)`);
                        lastCoord = stop.coord_val;
                    });

                    dailyRoute.push(`ğŸ›Œ æ™šä¸Šåœ¨ ${stops[stops.length - 1].name} é™„è¿‘ä½å®¿ã€‚`);
                    itinerary.push(`**ç¬¬ ${day + 1} å¤©:**\n* ` + dailyRoute.join('\n* '));
                }
            }

            return { 
                itinerary: itinerary.join('\n\n'), 
                totalDistance: totalDistance.toFixed(1),
                dailyStops: dailyStops
            };
        }

        // 7. è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°è¡Œç¨‹æ¦‚è¦½å´é‚Šæ¬„
        function updateSidebarOverview(dailyStops) {
            const menu = document.getElementById('itinerary-days-menu');
            menu.innerHTML = '';
            
            if (!dailyStops || dailyStops.length === 0) {
                menu.innerHTML = '<li><a href="#" class="neumorphism-item disabled">é»æ“Šã€Œç”Ÿæˆå„ªåŒ–è·¯ç·šã€</a></li>';
                filterCardsByDay(0); 
                return;
            }

            menu.innerHTML += `
                <li>
                    <a href="#" class="neumorphism-item route-day-btn active" data-day="all">
                        ğŸ‘ï¸ é¡¯ç¤ºæ‰€æœ‰è¡Œç¨‹æ™¯é»
                    </a>
                </li>
            `;

            dailyStops.forEach((dayStops, index) => {
                const day = index + 1;
                const totalStops = dayStops.length;
                
                menu.innerHTML += `
                    <li>
                        <a href="#" class="neumorphism-item route-day-btn" data-day="${day}">
                            ğŸ—“ï¸ ç¬¬ ${day} å¤© (${totalStops} ç«™)
                        </a>
                    </li>
                `;
            });
        }
        
        // 8. è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šå¤©æ•¸ç¯©é¸æ™¯é»å¡ç‰‡
        function filterCardsByDay(day) {
            const allCards = document.querySelectorAll('.attraction-card');
            
            let visibleIds = [];
            let attractionsToShow = [];

            if (day === 0) { // é¡¯ç¤ºæ‰€æœ‰åŸå§‹å¡ç‰‡ (ç„¡è¡Œç¨‹)
                allCards.forEach(card => card.style.display = 'flex');
                updateMapDisplayMultiple([]);
                return;
            } else if (day === 'all' && currentOptimizedRoute) { // é¡¯ç¤ºæ‰€æœ‰è¡Œç¨‹æ™¯é»
                attractionsToShow = currentOptimizedRoute.flat();
            } else if (currentOptimizedRoute && day > 0) { // é¡¯ç¤ºæŒ‡å®šå¤©æ•¸çš„æ™¯é»
                const dayIndex = day - 1;
                if (currentOptimizedRoute[dayIndex]) {
                    attractionsToShow = currentOptimizedRoute[dayIndex];
                }
            }
            
            visibleIds = attractionsToShow.map(a => a.id);
            
            allCards.forEach(card => {
                const cardId = card.getAttribute('data-id');
                card.style.display = visibleIds.includes(cardId) ? 'flex' : 'none';
            });

            updateMapDisplayMultiple(attractionsToShow);
        }
        
        // 9. è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°åœ°åœ–å±•ç¤ºå€ (å¤šæ™¯é»æ¨¡å¼)
        function updateMapDisplayMultiple(attractions) {
            const mapPlaceholder = document.getElementById('map-placeholder');
            const color = attractions.length > 0 ? '#f0f4f8' : '#d8dee8';
            
            if (attractions && attractions.length > 0) {
                const attractionNames = attractions.map(a => a.name).join(' -> ');
                mapPlaceholder.innerHTML = `
                    <h3>ğŸ—ºï¸ ç•¶å‰è¡Œç¨‹åœ°åœ–è¦–åœ–</h3>
                    <p>åœ°åœ–æ¨¡æ“¬ï¼šé¡¯ç¤º ${attractions.length} å€‹æ™¯é»ä¸¦æ¨™è¨˜è·¯ç·š:</p>
                    <p style="font-weight:normal;">${attractionNames}</p>
                    <p style="color:#007bff; font-weight:normal;">(å¯¦éš›æ‡‰ç”¨ä¸­æ­¤è™•æœƒé¡¯ç¤ºè¡Œç¨‹é€£ç·šåœ–)</p>
                `;
            } else {
                mapPlaceholder.innerHTML = '[åœ°åœ–æ¨¡æ“¬ç•«é¢ï¼šé¡¯ç¤ºè·¯ç·šå’Œæ™¯é»æ¨™è¨˜]';
            }
            mapPlaceholder.style.backgroundColor = color;
        }

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. è¼‰å…¥æ™¯é»å¡ç‰‡
            loadAttractionCards();

            // 2. API é©—è­‰æŒ‰éˆ•
            document.getElementById('verify-api-btn').addEventListener('click', handleApiVerification);

            // 3. æ™¯é»å¡ç‰‡å€çš„äº‹ä»¶å§”æ´¾ (è™•ç†æ‰€æœ‰å¡ç‰‡æŒ‰éˆ•)
            document.getElementById('cards-container').addEventListener('click', (event) => {
                const target = event.target;

                if (target.classList.contains('toggle-details-btn')) {
                    const cardId = target.getAttribute('data-id');
                    toggleDetails(cardId);
                } else if (target.classList.contains('generate-image-btn')) {
                    const attractionName = target.getAttribute('data-name');
                    simulateAIGeneration(attractionName);
                }
            });
            
            // 4. è¤‡é›œè·¯ç·šè¦åŠƒæŒ‰éˆ•
            document.getElementById('generate-route-btn').addEventListener('click', () => {
                const start = document.getElementById('start-location').value || 'å°ç£ä»»ä¸€åœ°é»';
                const tags = document.getElementById('interest-tags').value;
                const days = document.getElementById('duration-days').value;
                const must = document.getElementById('must-visit').value;
                const resultDiv = document.getElementById('route-result');

                // æª¢æŸ¥æ˜¯å¦å·²é©—è­‰ API Key
                if (!localStorage.getItem('geminiApiKey')) {
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = '<p style="color:red;">è«‹å…ˆé©—è­‰æ‚¨çš„ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI è¦åŠƒåŠŸèƒ½ï¼</p>';
                    return;
                }

                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<p>ğŸš€ AI æ­£åœ¨è™•ç†è¤‡é›œçš„æ—…è¡Œæ¨éŠ·å“¡å•é¡Œ (TSP)...</p>';
                resultDiv.style.backgroundColor = '#f0f4f8';
                
                // æ¨¡æ“¬å»¶é²ï¼Œä¸¦é‹è¡Œå„ªåŒ–å™¨
                setTimeout(() => {
                    const routeData = generateOptimizedRoute(start, tags, days, must);

                    if (typeof routeData === 'string') {
                        resultDiv.innerHTML = `<p style="color:red;">${routeData}</p>`;
                        currentOptimizedRoute = null;
                        updateSidebarOverview(null);

                    } else {
                        resultDiv.innerHTML = `
                            <h4>âœ… æœ€ä½³åŒ–è¡Œç¨‹ (å…± ${routeData.totalDistance} km æ¨¡æ“¬è·é›¢)</h4>
                            <pre style="white-space: pre-wrap; background: #e0e5ec; padding: 10px; border-radius: 8px;">${routeData.itinerary}</pre>
                            <p><em>æ­¤è·¯ç·šå·²æ ¹æ“šæ‚¨çš„åå¥½å’Œåœ°ç†ä½ç½®æ¡ç”¨è²ªå©ªæ³•é€²è¡Œå„ªåŒ–ã€‚</em></p>
                        `;
                        
                        currentOptimizedRoute = routeData.dailyStops;
                        updateSidebarOverview(routeData.dailyStops);
                        
                        // é è¨­é¡¯ç¤ºç¬¬ä¸€å¤©çš„æ™¯é»
                        filterCardsByDay(1); 
                        
                        // ç¢ºä¿å°‡ç¬¬ä¸€å¤©æŒ‰éˆ•è¨­ç‚º active
                        document.querySelectorAll('.route-day-btn').forEach(btn => btn.classList.remove('active'));
                        document.querySelector('.route-day-btn[data-day="1"]').classList.add('active');
                    }
                    resultDiv.style.backgroundColor = 'var(--main-color)';
                }, 1500);
            });
            
            // 5. è¡Œç¨‹æ¦‚è¦½èœå–®äº‹ä»¶å§”æ´¾
            document.getElementById('itinerary-days-menu').addEventListener('click', (event) => {
                const target = event.target.closest('.route-day-btn');
                if (target && !target.classList.contains('disabled')) {
                    event.preventDefault();

                    document.querySelectorAll('.route-day-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#category-menu a').forEach(btn => btn.classList.remove('active'));
                    
                    target.classList.add('active');
                    
                    const day = target.getAttribute('data-day');
                    
                    if (day === 'all') {
                        filterCardsByDay('all');
                    } else {
                        filterCardsByDay(parseInt(day, 10));
                    }
                }
            });

            // 6. åŸå§‹åˆ†é¡é¸å–®äº‹ä»¶ (é¡¯ç¤ºæ‰€æœ‰æ™¯é»ï¼Œä¸¦é‡ç½®è¡Œç¨‹æ¦‚è¦½)
            document.getElementById('category-menu').addEventListener('click', (event) => {
                const target = event.target.closest('a');
                if (target) {
                    event.preventDefault();

                    document.querySelectorAll('#category-menu a').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.route-day-btn').forEach(btn => btn.classList.remove('active'));

                    target.classList.add('active');
                    
                    // é‡ç½®ï¼Œé¡¯ç¤ºæ‰€æœ‰æ™¯é»
                    filterCardsByDay(0);
                    updateMapDisplayMultiple([]);
                }
            });
        });
    </script>
</body>
</html>
